> 国防科大的硕士论文，学习一下周跳的处理

## 摘要

载波相位测量精度高于伪距，在高精度定位应用中，载波相位测量值是不可或缺的观测量。然而，载波相位测量值含有模糊度，受外界环境或接收机本身环路影响，模糊度有时会发生跳变，即产生周跳，因此，使用载波相位进行定位解算时必须解决载波相位的周跳探测与修复。本文根据接收机可获得的频点个数不同，分别从单频、双频 和三频的角度分析了周跳探测方法及其性能，主要工作如下：

* 介绍了单频、双频、三频目前常用的周跳探测与修复的算法模型；对比了单频算法中各算法的探测精度，并分析了影响各方法探测精度的主要因素。
* 通过最小二乘法将两种双频周跳探测技术融合使用，提出了基于 MW 组合辅助的电离层残差双频周跳探测改进技术。对小周跳、特殊周跳及密集周跳有较好效果。
* 提出了一种基于多项式拟合法的三频周跳探测改进算法， 改进算法不再限制无几何约束，从而可以获得三组单纯利用载波相位观测量的线性组合，由于不用伪距观测量，因此改进算法提高了探测精度。

## 二、周跳机理及单频周跳探测方法对比分析

### 1、GNSS 基本观测量

#### 1.伪距

卫星按照其自备的卫星时钟在 $t^{s}$ 时刻发射卫星信号，GNSS 接收机在接收机钟面时刻 $t_{u}$ 处收到信号，用光速 $\mathrm{c}$ 乘上这个时间差，理论上就是卫星到接收机的几何距离，由于传播过程中包含多种误差，因此，该距离并非真正的星地几何距离，称此距离为伪距。其表达式如下:
$$
\rho_{u}^{s}=c\left(t_{u}-t^{s}\right)=r+c\left(\delta t_{u}-\delta t_{s}\right)+I+T+\varepsilon_{\rho}
$$
#### 2.载波相位

载波相位测量值来源于**载波环**和**整周计数器**，载波环产 生小于 1 周的载波相位小数部分，整周计数器产生从锁定卫星信号开始测量一直到当前时刻的载波相位整周数，周跳的直接来源就是由于某些原因导致整周计数器暂停工作，不再累积计数。

接收机实际测量的载波相位测量值由两部分组成，即不足一整周的部分 $F r(\varphi)$ 和锁定信号之后的整周累计计数 $\operatorname{int}(\varphi)$ 。用 $\varphi$ 表示载波相位实际观测值，则有:
$$
\dot{\varphi}=\operatorname{int}(\varphi)+\operatorname{Fr}(\varphi)\
$$
真正的几何距离与实际测量值之间相差一个整周模糊度 $N$ 用 $\varphi$ 表示真实几何距离，则有：
$$
\varphi=N+\dot{\varphi}=N+\operatorname{int}(\varphi)+\operatorname{Fr}(\varphi)
$$
考虑传播路径中的各类误差，则以米为单位的载波相位测量值表达式为：
$$
\phi=\lambda \varphi=r+c\left(\delta t_{u}-\delta t_{s}\right)-I+T+\varepsilon_{\phi}-\lambda N
$$
> $\phi$ 表示以米为单位的载波相位， $\varphi$ 表示以周为单位的载波相位;

#### 3.多普勒

多普勒测量值虽然也由载波环产生，但它读取的是载波环输出的 **NCO 频率控制字**，即读取的是频移值，而并非是载波相位测量值的导数。因此，载波相位测量值与多普勒测量值是并行产生的，多普勒测量值与整周计数器无关，因此**多普勒测量值对周跳不敏感**。

多普勒观测量与载波相位之间存在积分微分关系，对载波相位进行微分，即可得多普勒观测量表示式如下：
$$
D=\frac{d \phi}{d t} \text { 或 } D=\frac{d \varphi}{d t}
$$
$D$ 表示多普勒测量值，其单位不统一，在 RINEX 格式中，其默认单位是 $\mathrm{Hz}$，在接收机原始数据输出时，其默认单位是 $\mathrm{m} / \mathrm{s}$ 。**工程实践中如果牵扯到处理实测数据，必须明确多普勒单位，并将多普勒单位进行统一**。另外，特别注意，处理 RINEX 格式的数据时，载波相位与多普勒的关系是负相关，因此，其积分表达式为：
$$
\varphi_{k+1}=-\int_{-\infty}^{k+1} d \bullet d t-N_{k+1}
$$

### 2、周跳成因及探测机理

载波相位实际测量值由两部分组成，小数部分 $\operatorname{Fr}(\varphi)$ 和整周计数部分 $\operatorname{int}(\varphi)$ 。**小数部分**可以由载波跟踪环中的**鉴相器**测定，**整周计数部分**是从首次观测时刻 $t_{0}$ 开始至当前观测时刻 $t_{i}$ 为止用**计数器逐个累积**下来的信号中的整波段数。如果因为某些原因在两个观测历元 $\left[t_{i-1}，t_{i}\right]$ 间的某一段时间计数器**中止**了正常的累积工作，从而使整周计数相对于应有值来说少了 $n$ 周，那当**计数器恢复正常工作之后，所有的之后的载波相位观测值中便都含有了同一偏差值**。这种整周计数出现系统偏差但小数部分仍保持正确的现象称为周跳。

当没有周跳时，由于卫星在空间的运行轨迹是一条**平滑的曲线**，因而卫星至接收机的距离观测值的变化也是平缓而有规律的。**周跳的出现将破坏这种规律性**，使观测值产生一种系统性的偏差。因此可根据周跳的这一特性进行周跳的探测与修复。周跳探测与修复的本质就是从载波相位观测值的时间序列中找到这种偏差并对这个偏差进行修正。

### 3、单频周跳探测算法模型

当接收机只可稳定接收一个频点的信号时，可用的观测量只有单频伪距、单 频载波相位和单频多普勒测量值。为进行周跳探测，构造的检测量中不能含几何距离，因此在构造检测量时，需要**为原始载波提供一个几何基准**，载波相位减去该几何基准之后便不再含有几何距离，可利用该检测量进行周跳探测。根据几何 基准构造方法不同，单频周跳探测方法分为以下几种：

* 多项式拟合法通过**前几个历元的载波相位**的多项式拟合值提供几何基准。
* 单频码相组合法通过**伪距**测量值提供几何基准。
* 多普勒积分法是通过对**多普勒积分**提供几何基准。

#### 1.多项式拟合法

多项式拟合法基于观测值平滑变化，则观测值可以用一定阶数的多项式进行拟合。由于星地距离的 4 次差分后残差已经呈现噪声形式，因此本文采用 4 阶多 项式。多项式拟合模型为：
$$
\varphi_{i}=a_{0}+a_{1}\left(t_{i}-t_{0}\right)+a_{2}\left(t_{i}-t_{0}\right)^{2}+a_{3}\left(t_{i}-t_{0}\right)^{3}+a_{4}\left(t_{i}-t_{0}\right)^{4}
$$
式中：$a_{i}$ 是拟合系数， $\varphi_{i}$ 是载波相位（以周为单位），取定窗口宽度为 6，则算法流程为：

1. 利用前 6 个历元进行多项式拟合
2. 计算其中误差，将 3 倍中误差作为探测阈值
3. 根据拟合后的系数计算第 7 个历元的预测值
4. 将预测值与实际观测值作差，将该差值的绝对值作为检测量，如果该检测量大于探测阈值，认为有周跳；反之，没有周跳。

> * 多项式拟合法的基本假设是观测值平滑变化，这要求接收机动态性不可很高。
> * 将实际观测值与预测值相减可排除几何距离，并不能排除接收机噪声的影响。
> * 接收机钟差在各个时刻是不相同的，作差无法消除，因此多项式拟合法对不同时钟性能的接收机具有不同的探测效果。

#### 2.单频码相组合法

伪距和载波相位都含有几何距离项，因此考虑用伪距为载波相位测量值提供几何基准，构造检测量如下：
$$
\varphi-\frac{\rho}{\lambda}=-2 \frac{I}{\lambda}-N
$$
考虑到一般情况下电离层延迟变化不大，因此对上式进行历元间差分，其变化值应为一个小量，当历元间差分结果明显增大时，认为出现周跳。

>* 电离层延迟对伪距和载波影响相反，作差之后，对流层延迟抵消，电离层加倍。
>* 其残差项中含有电离层延迟，因此当电离层延迟活跃时，该方法探测精度不高。
>* 由于其使用了伪距观测量，因此其探测精度还受到伪距噪声的影响，精度较低。

#### 3.多普勒积分法

多普勒与载波相位存在积分微分关系，且由于多普勒可以反应星地连线的速度信息，对多普勒积分后也可以为载波相位提供几何基准。

对于多普勒测量值，需要明确其单位。对实验室自研监测接收机而言，其多普勒单位为 $m/s$；对标准导航输出格式 RINEX 格式而言，其多普勒单位是 $Hz$。即其前者以速度量表示，后者以频率量表示，考虑到 $c=\lambda f$，两者之间相差一个波长单位。工程实践中如果牵扯到处理实测数据，必须明确多普勒单位，并将多普勒单位进行统一。为详细说明多普勒测量值在载波相位测量值及载波相位真实值 之间的关系，重新定义如下变量：
$$
\begin{array}{}

\varphi_{\mathrm{int}}: & \text { 表示整周计数器累计整周计数, 单位为周 } \\

\varphi_{\text {float }}: & \text { 表示载波环输出的精确测量得到的载波相位小数部分, 单位为周 } \\

N: & \text { 表示整周模糊度, 单位为周 } \\

\varphi_{a l l}: & \text { 表示星地真实的载波相位值, 含有模糊度, 单位为周 } \\

\varphi: & \text { 表示载波相位测量值, 不含模糊度, 单位为周 } \\

D: & \text { 表示距离域的多普勒测量值, 单位为 } \mathrm{m} / \mathrm{s} \\

d: & \text { 表示频率域的多普勒测量值, 单位为 } \mathrm{Hz}\\

\phi:& \text { 表示载波相位测量值，不含模糊度，单位为米 }\\

\dot{X} :&\text { 表示 X 对时间 t 的一阶导数 }\\

\end{array}
$$
对载波相位，有如下关系：
$$
\begin{array}{c}

\varphi_{\text {all }}=N+\varphi_{\text {itt }}+\varphi_{\text {float }} \\

\varphi_{\text {all }}=\frac{1}{\lambda}\left(r+c\left(\delta t_{u}-\delta t_{s}\right)+T-I+\varepsilon_{\varphi}\right)

\end{array}
$$
则载波相位实际测量值与载波相位真实值之间的关系为：
$$
\varphi=\varphi_{\text {int }}+\varphi_{\text {float }}=\varphi_{\text {all }}-N
$$
>多普勒测量值应该对应哪个量的微分？
>* 从原理上理解：多普勒测量值涉及的范围应该是卫星到用户整体的路径。因此，多普勒测量值应对应载波相位真实值 $\varphi_{a l l}$ 对时间的微分，而非载波相位测量值 $\varphi$ 对时间的微分。
>* 测量来源上理解：多普勒测量值是直接读取载波环输出的 NCO 频率控制字，而并非是载波相位测量值的导数。载波相位测量值与多普勒测量值是并行产生的，多普勒测量值与 整周计数器无关，因此多普勒测量值对周跳不敏感。

可写出多普勒测量值与载波相位关系如下：
$$
D=\lambda \dot{\varphi}_{a l l}=\lambda(\dot{\varphi}+\dot{N})=\lambda d
$$
考虑到 RINEX 格式中多普勒与载波相位的负相关性，载波相位观测值：
$$
\varphi=\int_{-\infty}^{t} d \cdot d t-N
$$
考虑 $k+1$ 和 $k$ 两个时刻两式相减：
$$
\begin{array}{l}

\varphi_{k+1}-\varphi_{k}=\left(-\int_{-\infty}^{k+1} d \cdot d t-N_{k+1}\right)-\left(-\int_{-\infty}^{k} d \cdot d t-N_{k}\right) \\

=-\int_{k}^{k+1} d \cdot d t-\left(N_{k+1}-N_{k}\right)=-\int_{k}^{k+1} d \cdot d t-\Delta N

\end{array}
$$
由此可得周跳检测量为：
$$
\Delta N=\varphi_{k+1}-\varphi_{k}+\int_{k}^{k+1} d \cdot d t
$$
理想情况下, 当没有周跳时, $\Delta N$ 应为 0 , 考虑到噪声的影响, $\Delta N$ 应在 0 附近抖动。如果 $\Delta N$ 明显增大, 则认为出现了周跳。

### 3、单频周跳探测方法对比分析

#### 1.探测精度对比

![[Pasted image 20230525204326.png]]

* 横向比较，可以发现：同一探测方法， 同一卫星，对不同的接收机，探测精度不同。
* 纵向比较，可以发 现：对同一方法，同一接收机，不同卫星，探测精度接近。
* **多普勒积分法探测效果最好**，原因是其采用的观测量是载波相位和多普勒观测量，两种观测量精度均较高。
* **多项式拟合法探测效果次之**， 原因是虽然其采用载波相位观测量，精度较高，但其仍旧存在拟合误差，对精度有一定的影响。
* **单频码相组合法探测精度最差**，原因是其采用了伪距测量值，噪声大，精度低。

#### 2.探测精度主要影响因素对比

影响接收机观测量精度的因素主要有三方面：与卫星有关的误差，如星历误差、卫星钟差等；与传播路径有关的误差，如电离层延迟、对流层延迟 等；与接收机有关的误差，如接收机噪声、多径效应等。为进一步分离出影响各 个方法探测精度的影响因素，下面在非差观测值基础上，构造站间单差、星间单差数据。

* 对于零基线或短基线的情况，站间单差数据可以完全消除卫星钟差，大部分消除传播路径上的误差，因此若站间**单差结果精度提升，说明卫星钟差是主要影响因素**。
* 星间单差数据可以完全消除接收机钟差，也可以大部分消除传播路径上 的误差，因此若**星间单差结果精度提升，说明接收机钟差是主要因素**。
* 由于站间单差、星间单差均涉及到线性组合，均放大了观测噪声，因此**若站间和星间单差 结果精度均恶化，说明接收机噪声是主要影响因素**。
* 如果星间和站间单差结果中 有一个恶化一个不变或两个都不变，说明接收机钟差、接收机噪声、卫星钟差均不是主要影响因素，其主要影响因素未知，用其他表示。

![[Pasted image 20230525203354.png]]

由表可知：

* **多项式拟合法**：星间单差结果对两种接收机来说精度均得到改善，而站间单差结果对两颗卫星来说精度均有一定程度的恶化。说明：**接收机钟差**是影响周跳探测精度的主要因素，如果能有效的补偿接收机钟差对周跳探测的影响，探测精度将得到大幅度提高。
* **单频码相组合法**：星间单差和站间单差结果相比较于非差结果来说， 均有一定程度的恶化。说明：**接收机噪声**是影响周跳探测精度的主要因素，如果想要提高探测精度，必须设法降低接收机噪声，可考虑多历元平滑方法来降低噪声。
* **多普勒积分法**：星间单差之后，Septentrio 接收机探测精度明显提升，ublox 接收机精度虽然也有一定改善，但改善程度不大，站间单差之后，两颗卫星 周跳的探测精度均有小幅度的恶化。说明：其主要影响因素与具体接收机有关，由 于探测结果对不同的接收机不存在一致性，因此，**无法说明影响多普勒积分法探测精度的主要影响因素**。

![[Pasted image 20230525203321.png]]


## 三、基于 MW 组合辅助的电离层残差双频周跳探测改进技术

### 1、电离层残差法

对于同一时刻两个频点的载波相位观测数据，其应包含相同的几何距离及非弥散性误差，因此可以互相作为几何基准。根据这个前提，可得消去几何距离和非弥散性误差的电离层残差组合为：
$$
\phi_{G F}=\lambda_{1} \varphi_{1}-\lambda_{2} \varphi_{2}=\lambda_{2} N_{2}-\lambda_{1} N_{1}+I_{2}-I_{1} \\
=\lambda_{2} N_{2}-\lambda_{1} N_{1}+\left(1-\frac{f_{1}^{2}}{f_{2}^{2}}\right) I_{1}
$$
上述检测量不含几何距离，对其进行历元间作差，得：
$$
\Delta_{i o n}\left(t_{k+1}\right)=\phi_{G F}\left(t_{k+1}\right)-\phi_{G F}\left(t_{k}\right)=\lambda_{2} \Delta N_{2}-\lambda_{1} \Delta N_{1}+\left(1-\frac{f_{1}^{2}}{f_{2}^{2}}\right) \Delta I_{1}
$$
当电离层变化较小时，$\Delta I_{1}$ 趋向于 0，故可构造检测量如下：

$$
\begin{array}{l}
l_{-} \text {iono_1 }=\frac{\Delta_{i o n}\left(t_{k+1}\right)}{\lambda_{3}}=\Delta N_{3}-\frac{\lambda_{1}}{\lambda_{3}} \Delta N_{1} \\
l_{-i o n O_{-}} 2=\frac{\Delta_{i o n}\left(t_{k+1}\right)}{\lambda_{1}}=\frac{\lambda_{3}}{\lambda_{1}} \Delta N_{3}-\Delta N_{1}
\end{array}
$$

将上述两式进行历元间相减，即可得周跳检测量。由于只涉及相邻两个历元， 故可有效探测连续周跳，其探测原理如下：

假设i 时刻发生 1 周周跳，i +1时刻又发生 1 周周跳，此时即为发生了连续周 跳，以l _iono _1为例，则有：
$$
\begin{array}{l}
\text { abs }\left(l_{-} \text {iono_1 } 1(i)-l_{-}{ }^{i o n o} o_{-} 1(i-1)\right)>\varsigma \\
a b s\left(l_{-} i o n o_{-} 1(i+1)-l_{-} i o n o_{-} 1(i)\right)>\varsigma
\end{array}
$$
其中, $a b s(\bullet)$ 表示取绝对值, $\varsigma$ 表示探测阈值。粗差的特性与连续周跳一致, 此处不加区分。 

### 2、MW 组合法

伪距观测方程和载波相位观测方程可以简化为如下形式：
$$
\left\{\begin{array}{l}
P_{1}=\rho-\frac{A}{f_{1}^{2}} \\
P_{2}=\rho-\frac{A}{f_{2}^{2}} \\
\varphi_{1}=\frac{\rho}{\lambda_{1}}+\frac{A}{c f_{1}}-N_{1} \\
\varphi_{2}=\frac{\rho}{\lambda_{2}}+\frac{A}{c f_{2}}-N_{2}
\end{array}\right.
$$
式中, $\rho$ 为卫星至接收机的距离与所有和频率无关的偏差改正项之和, $P_{1} 、 P_{2}$ 是两个频点伪距, 其余各量含义与前相同。由同一历元的相位观测值的宽巷组合减伪距观测值的窄巷组合求得：
$$
\begin{array}{c}
-N_{w}=  N_{2}-N_{1}=\\-\frac{f_{1}-f_{2}}{f_{1}+f_{2}}\left(\frac{P_{1}}{\lambda_{1}}+\frac{P_{2}}{\lambda_{2}}\right)+\left(\varphi_{1}-\varphi_{2}\right) 
 =-\frac{f_{1}-f_{2}}{f_{1}+f_{2}}\left(\frac{f_{1} P_{1}}{c}+\frac{f_{2} P_{2}}{c}\right)+\left(\varphi_{1}-\varphi_{2}\right) 
= \\ -\frac{f_{1}-f_{2}}{c}\left(\frac{f_{1} P_{1}+f_{2} P_{2}}{f_{1}+f_{2}}\right)+\left(\varphi_{1}-\varphi_{2}\right)=-\frac{1}{\lambda_{w}}\left(\frac{f_{1} P_{1}+f_{2} P_{2}}{f_{1}+f_{2}}\right)+\left(\varphi_{1}-\varphi_{2}\right)
\end{array}
$$
式中, $\lambda_{w}=\frac{c}{f_{1}-f_{2}}$ 为宽巷波长。上述线性组合不仅消除了电离层了延迟，也消除了卫星钟差、接收机钟差和星地距离，仅受测量噪声和多径的影响。但由于检测量中使用了伪距，测量噪声较大，因此为提高检测精度，应进行加窗处理。

### 3、探测阈值选取

对于 MW 组合法，其检测量实际上就是宽巷模糊度，因此其检测量理论上应为整数，考虑到噪声的影响，其检测量应在整数附近抖动，故可将其探测阈值设定为 0.5，当检测量超过 0.5 时，认为出现了周跳，对检测量就近取整即可。考虑到伪距噪声较大，直接对检测量进行历元间作差精度较差，无法固定小周跳，因此采用加窗处理，经实际实验分析，窗口宽度选取为 10 个历元。

对于电离层残差法，其检测量系数中含有波长比，故对于两个频点同时发生周跳时，检测量不再保持整数特性，不可通过就近取整来固定周跳，即阈值不可选择为 0.5，





### 4、基于 MW 组合辅助的改进电离层残差法探测周跳算法

根据周跳是否密集发生，可将周跳分为密集周跳和非密集周跳。下面分别说明。

#### 1.密集周跳

定义密集周跳为给定窗口宽度后，在窗口宽度内发生多次周跳，周跳时刻可以连续，可以不连续。连续周跳看成是密集周跳的特例。

MW 组合法探测周跳时，由于伪距精度限制，需对探测时刻的检测量进行前后加窗平滑，以降低噪声。假设窗口宽度为 10，如下两图：

![1685111819220](https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/1685111819220.png)

如上图所示, $a$ 图表示 $\mathrm{i}$ 时刻发生 1 周周跳, $b$ 图表示 $\mathrm{i}$ 时刻发生 1 周周跳且 $\mathrm{i}+5$ 时刻又发生 2 周周跳, 即发生了密集周跳。现在计算加窗平滑后的 $\mathrm{i}$ 时刻的周 跳值。对于 $\mathrm{a}$ 图, 计算出的 $\mathrm{i}$ 时刻的周跳值为 $\frac{1}{10} \times 2 \times 10-\frac{1}{10} \times 1 \times 10=1$, 符合理论值; 对于 $\mathrm{b}$ 图, 计算出的 $\mathrm{i}$ 时刻的周跳值为 $\frac{1}{10} \times(2 \times 5+4 \times 5)-\frac{1}{10} \times 1 \times 10=2$, 不符合理论值。即**如果发生密集周跳之后, 输出的检测量的值是错误的**。因此**发生密集周跳时必须对周跳时刻进行标记, 不进行周跳修复**。而密集周跳的判定可以利用电离层残差法进行。

#### 2.非密集周跳

对于非密集周跳，指在窗口宽度内只发生一次周跳的情况。根据发生周跳的特性，又可以将其细分为小周跳和特殊周跳。

小周跳指两个频点同时或只有一个频点发生 1 周周跳时的情形，此时由于周跳值较小，较难探测，故在实验数据分析时需要对这种周跳的探测效果进行验证

特殊周跳指使得电离层残差检测量最小的周跳值，前面算法模型中已经提到，对于北斗 B1、B3 频点，当 B1 频点发生 5 周周跳、B3 频点发生 4 周周跳时，电离层残差法的检测量最小，因此需要验证当发生这种周跳时改进算法能否将其有效的探测出来。

#### 3.算法原理

通过最小二乘法将两种方法进行融合，以期修复各种情况下的周跳。原理图如下：  

![1685112180128](https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/1685112180128.png)

具体步骤如下：

**Step1：读入数据**

读入双频载波相位测量值和伪距测量值，本算法以北斗 B1B3 双频点数据为例讨论。

**Step2：电离层残差法产生检测量**

消去几何距离及非弥散性误差的电离层残差组合为：
$$
\begin{array}{c}
\phi_{G F}=\lambda_{1} \varphi_{1}-\lambda_{3} \varphi_{3}=\lambda_{3} N_{3}-\lambda_{1} N_{1}+I_{3}-I_{1} \\
=\lambda_{3} N_{3}-\lambda_{1} N_{1}+\left(1-\frac{f_{1}^{2}}{f_{3}^{2}}\right) I_{1}
\end{array}
$$
对其进行历元间作差：
$$
\begin{array}{l}
\Delta_{\text {ion }}\left(t_{k+1}\right)=\phi_{G F}\left(t_{k+1}\right)-\phi_{G F}\left(t_{k}\right) \\
=\lambda_{3} \Delta N_{3}-\lambda_{1} \Delta N_{1}+\left(1-\frac{f_{1}^{2}}{f_{3}^{2}}\right) \Delta I_{1}
\end{array}
$$
当电离层变化较小时, $\Delta I_{1}$ 趋向于 0 , 故构造检测量如下: 
$$
\begin{array}{l}
l_{-} \text {iono_1 } 1\left(t_{k+1}\right)=\frac{\Delta_{\text {ion }}\left(t_{k+1}\right)}{\lambda_{3}} \\
l_{\text {_iono_2 } 2\left(t_{k+1}\right)=} \frac{\Delta_{\text {ion }}\left(t_{k+1}\right)}{\lambda_{1}}
\end{array}
$$
易知，检测量与周跳值之间的关系如下：
$$
l{-i o n o} 1=\Delta N{3}-\frac{\lambda{1}}{\lambda{3}} \Delta N_{1}\\
l_{-} \text {iono_2 } 2=\frac{\lambda_{3}}{\lambda_{1}} \Delta N_{3}-\Delta N_{1}
$$
**Step3：判断密集周跳**

给定一个窗口宽度 window, 判断密集周跳方法如下： 

假设 $i$ 时刻两个频点任意一个频点（或两个频点同时）发生 1 周周跳, $i+k(k<$ window $)$ 时刻两个频点任意一个频点（或两个频点同时）发生 1 周周跳, 则: 
$$
\begin{array}{l}\mid l_{-} \text {iono_ } 1(i)-l_{-} \text {iono_ } 1(i-1) \mid>\varsigma \\
\mid l_{-} \text {iono_2 } 2(i)-l_{-} \text {iono_ } 2(i-1) \mid>\varsigma\end{array}\\
\begin{array}{l}\mid l_{-} \text {iono_1 } 1(i+k)-l_{-} \text {iono_ } 1(i+k-1) \mid>\varsigma \\
\mid l_{-} \text {iono_2 } 2(i+k)-l_{-} \text {iono_ } 2(i+k-1) \mid>\varsigma\end{array}
$$
其中, $\varsigma$ 为电离层残差法周跳探测阈值, 取 0.03 。当以上 4 个不等式同时成立时，认为发生了密集周跳。 

**Step4：双频码相组合法产生检测量**

组合后表达式为：
$$
\frac{1}{\lambda_{w}}\left(\frac{f_{1} P_{1}+f_{3} P_{3}}{f_{1}+f_{3}}\right)-\left(\varphi_{1}-\varphi_{3}\right)=N_{1}-N_{3}=N_{w}
$$
该组合消除了几何距离和电离层延迟, 实际检测值理论上就是宽巷模糊度。 为降低因使用伪距观测量而造成的噪声较大的问题, 对上述检测量前后进行加窗处理, 之后再进行周跳探测。经过 Trimble、信号源等多种实际数据分析, 窗口宽度取为 10 时, 精度已经满足要求 (此时探测精度 $<0.5$ 周, 可通过取整固定 1 周的周跳）, 因此窗口宽度 window 取为 10 。具体操作如下：

1. **构造平滑量**
   $$
   \begin{array}{l}
   N_{\text {wfromt }}(i)=\frac{1}{\text { window }} \sum_{t=i-\text { window }}^{i-1} N_{w}(t) \\
   N_{\text {wbehind }}(i)=\frac{1}{\text { window }} \sum_{t=i}^{i+\text { window-1 }} N_{w}(t)
   \end{array}
   $$

2. **构造检测量** 
   $$
   \text { check_MW_temp }(i)=N_{\text {wbehind}}(i)N{\text {wfront }}(i)\
   $$

3. **确定周跳发生时刻**

   如下图所示, 假设 $i$ 时刻发生周跳（图中坚线表示 $check_MW_temp(i)$ ) 

   ![1685112991699](https://pic-bed-1316053657.cos.ap-nanjing.myqcloud.com/img/1685112991699.png)

4. **确定宽巷周跳**

   确定了周跳时刻之后，将检测量在周跳时刻进行取整处理，其他时刻置零。 即：
   $$
   \text { check_MW }=\text { round }(\text { check_MW_temp(i)) }
   $$
   其中, $\operatorname{round}(\bullet)$ 表示取整。特别注意, 并不是对所有 $c h e c k_{-} M W_{-} t e m p(i)$ 取 整, 只有通过第三步确定周跳时刻之后, 在对周跳时刻的 $check_MW_temp(i)$ 取整, 其他时刻的周跳值不管 $check_MW_temp(i)$ 取整后是否为 0 , 都统一置零。 

**Step5：最小二乘法解算各频点周跳**

由以上讨论，当没有密集周跳（连续周跳看成是密集周跳的特例）时，可以综合利用电离层残差法和双频码相组合法，构造矩阵相乘，恢复各个频点的周跳， 其表达式如下：
$$
A N=L
$$

$$
A=\left(\begin{array}{cc}
1 & -1 \\
1 & -\frac{\lambda_{1}}{\lambda_{3}} \\
\frac{\lambda_{3}}{\lambda_{1}} & -1
\end{array}\right), \quad N=\left(\begin{array}{l}
N_{3} \\
N_{1}
\end{array}\right), \quad L=\left(\begin{array}{c}
\text { check_MW } \\
\text { check_iono_1 } \\
\text { check_iono_2 }
\end{array}\right)
$$

最小二乘解算结果为：
$$
N=\left(A^{T} A\right)^{-1} A^{T} L
$$
对 $N$ 的两个分量取整, 即为各频点的周跳值。 

**Step6：根据密集周跳时刻将对应周跳值置零**

据电离层残差法标记的密集周跳时刻，将密集周跳时刻开始的 $window$ 个周跳值置零，即将发生密集周跳的时刻进行标记，但不进行周跳修复。